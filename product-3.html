<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- تم تعديل عنوان الصفحة ليعكس المنتج الصحيح -->
    <title>ORLANDA - orlanda المصري</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- NEW: Page Transition --- */
        body {
            opacity: 0; /* Start transparent */
            transition: opacity 0.4s ease-in-out; /* Transition for fade-in */
        }
        body.fade-in {
            opacity: 1; /* Target state for fade-in */
        }
    </style>
    <style>
        /* --- Global Styles (Same as INDEX.HTML) --- */
        :root {
            --primary-color: #c9a96d;
            --font-arabic: 'Cairo', sans-serif;
            --font-english: 'Montserrat', sans-serif;
            --color-background: #ffffff;
            --color-text: #333333;
            --color-heading: #222222;
            --color-section-bg: #f9f9f9;
            --color-card-bg: #ffffff;
            --color-footer-bg: #222222;
            --color-footer-text: #ffffff;
            --color-header-transparent-text: #ffffff;
            --color-header-scrolled-bg: #ffffff;
            --color-header-scrolled-text: #333333;
            --color-header-scrolled-logo: #222222;
        }
        body.dark-mode {
            --color-background: #1a1a1a;
            --color-text: #cccccc;
            --color-heading: #f1f1f1;
            --color-section-bg: #252525;
            --color-card-bg: #2f2f2f;
            --color-header-scrolled-bg: #252525;
            --color-header-scrolled-text: #cccccc;
            --color-header-scrolled-logo: #f1f1f1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; /* لإزالة اللون الأزرق عند الضغط */ }
        body {
            font-family: var(--font-arabic);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-background);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; }
        h1, h2, h3 { font-weight: 700; line-height: 1.2; }
        a { text-decoration: none; color: var(--primary-color); }
        img { max-width: 100%; display: block; }
        .btn {
            display: inline-block; padding: 12px 30px; background-color: var(--primary-color);
            color: #fff !important; font-family: var(--font-arabic); font-weight: 700;
            border-radius: 5px; transition: background-color 0.3s ease, transform 0.3s ease;
            border: none; cursor: pointer;
        }
        .btn:hover { background-color: #b38f55; transform: translateY(-2px); }

        /* --- Header (Same as INDEX.HTML, but always scrolled) --- */
        .main-header {
            background-color: var(--color-header-scrolled-bg);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky; /* Changed from fixed */
            top: 0;
            z-index: 1000;
        }
        .main-header .container { display: flex; justify-content: space-between; align-items: center; }
        .header-right { display: flex; align-items: center; gap: 1.5rem; }
        .logo {
            font-family: var(--font-english); font-size: 2rem; font-weight: 700;
            color: var(--color-header-scrolled-logo);
        }
        .main-nav ul { list-style: none; display: flex; gap: 2rem; }
        .main-nav a {
            color: var(--color-header-scrolled-text);
            font-weight: 700; font-size: 1rem; transition: color 0.3s ease;
        }
        .main-nav a:hover { color: var(--primary-color); }
        .header-icons { display: flex; align-items: center; gap: 1.5rem; }
        .dark-mode-toggle, .cart-icon {
            background: transparent; border: none; cursor: pointer;
            color: var(--color-header-scrolled-text);
            font-size: 1.3rem; text-decoration: none;
        }
        .dark-mode-toggle .fa-sun { display: none; }
        body.dark-mode .dark-mode-toggle .fa-sun { display: inline-block; }
        body.dark-mode .dark-mode-toggle .fa-moon { display: none; }
        .menu-toggle { display: none; } /* Mobile menu styles are still here but not used on this page as much */

        /* --- زر الرجوع للمنتجات --- */
        .back-to-products-link {
            display: inline-block;
            margin-bottom: 2rem;
            color: var(--color-text);
            font-weight: 700;
            font-size: 1rem;
            transition: color 0.3s ease;
        }
        .back-to-products-link:hover {
            color: var(--primary-color);
        }
        .back-to-products-link i {
            margin-left: 8px;
        }

        /* --- Styles for Product Page --- */
        .product-page-section {
            padding: 4rem 0;
            background-color: var(--color-background);
        }
        .product-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            align-items: center;
        }
        .product-image-container img {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
        }
        .product-info-container h1 {
            font-size: 2.8rem;
            color: var(--color-heading);
            margin-bottom: 1rem;
        }
        .product-page-price {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }
        .product-description {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }
        .product-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-selector label {
            font-weight: bold;
        }
        .quantity-selector input {
            width: 60px;
            padding: 10px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }
        .add-to-cart-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
        }

        /* --- Coupon in Cart --- */
        .coupon-section { display: flex; gap: 10px; margin-bottom: 15px; }
        .coupon-section input {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-family: var(--font-arabic);
        }
        body.dark-mode .coupon-section input {
            background-color: #444;
            border-color: #666;
            color: var(--color-text);
        }
        .coupon-btn { padding: 10px 20px; flex-shrink: 0; }
        .coupon-message { font-size: 0.9rem; margin-bottom: 10px; text-align: center; min-height: 1.2em; }
        .coupon-message.success { color: #28a745; }
        .coupon-message.error { color: #e74c3c; }
        .discount-row { color: #28a745; font-size: 1rem; }

        /* --- NEW: User Auth Styles --- */
        .user-area, .user-info { display: flex; align-items: center; gap: 0.75rem; }
        .user-area a, .user-info span, .user-area .separator {
            color: var(--color-header-scrolled-text);
            font-weight: 700;
            font-size: 0.9rem;
            transition: color 0.4s ease;
        }
        .user-area a:hover { color: var(--primary-color); }
        .user-area .separator { opacity: 0.7; }
        .logout-btn { background: none; border: none; color: #e74c3c; cursor: pointer; font-family: var(--font-arabic); font-weight: 700; font-size: 0.9rem; padding: 0; }
        .logout-btn:hover { text-decoration: underline; }

        /* --- Other styles from INDEX.HTML (Footer, Modals, etc.) --- */
        .main-footer { background-color: var(--color-footer-bg); color: var(--color-footer-text); padding: 4rem 0 2rem; text-align: center; }
        .footer-content h3 { font-family: var(--font-english); font-size: 2rem; margin-bottom: 1rem; }
        .social-links { margin: 1.5rem 0; }
        .social-links a { color: var(--color-footer-text); margin: 0 1rem; font-size: 1.5rem; transition: color 0.3s ease; }
        .social-links a:hover { color: var(--primary-color); }
        .copyright { margin-top: 2rem; font-size: 0.9rem; color: #aaa; }
        .modal, .lightbox { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--color-card-bg); margin: auto; padding: 20px; border-radius: 8px; position: relative; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation-name: zoom; animation-duration: 0.4s; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        body.dark-mode .modal-header { border-bottom-color: #444; }
        .modal-header h3 { margin: 0; font-size: 1.5rem; color: var(--color-heading); }
        .modal-close { color: var(--color-text); position: absolute; left: 15px; top: 10px; font-size: 28px; font-weight: bold; background: none; border: none; cursor: pointer; }
        .cart-icon { position: relative; }
        .cart-counter { position: absolute; top: -8px; right: -10px; background-color: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid var(--color-header-scrolled-bg); transition: transform 0.2s ease, border-color 0.4s ease; transform: scale(0); }
        .cart-counter.visible { transform: scale(1); }
        #cart-items-container { max-height: 40vh; overflow-y: auto; padding-right: 10px; }
        .cart-item { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
        .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-details h4 { margin: 0 0 5px 0; font-size: 1rem; color: var(--color-heading); }
        .cart-item-details .price { font-size: 0.9rem; color: var(--color-text); }
        .cart-item-actions { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .quantity-controls { display: flex; align-items: center; border: 1px solid #ccc; border-radius: 5px; }
        .quantity-controls button { background: none; border: none; cursor: pointer; padding: 5px 10px; font-size: 1.2rem; color: var(--color-text); }
        .quantity-controls .quantity { padding: 0 10px; font-size: 1rem; }
        .remove-item-btn { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 0.8rem; }
        .cart-summary { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .summary-row { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; }
        .checkout-btn { width: 100%; padding: 15px; font-size: 1.1rem; }
        @keyframes zoom { from {transform:scale(0.5); opacity: 0;} to {transform:scale(1); opacity: 1;} }

        /* Responsive for Product Page */
        @media (max-width: 768px) {
            .product-details-grid {
                grid-template-columns: 1fr; /* Stack columns on mobile */
                gap: 2rem;
            }
            .product-info-container h1 {
                font-size: 2.2rem;
            }
            .product-page-price {
                font-size: 1.8rem;
            }
            .product-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .add-to-cart-btn {
                width: 100%;
                text-align: center;
            }
            /* Mobile Menu Styles (copied from index) */
            .menu-toggle { display: block; background: transparent; border: none; cursor: pointer; color: var(--color-header-scrolled-text); font-size: 1.5rem; padding: 0; z-index: 1005; }
            .menu-toggle .fa-times { display: none; }
            .menu-toggle.open .fa-bars { display: none; }
            .menu-toggle.open .fa-times { display: block; }
            .nav-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1003; }
            .nav-overlay.open { display: block; }
            .main-nav { position: fixed; top: 0; right: -100%; width: 70%; max-width: 300px; height: 100vh; background-color: var(--color-card-bg); box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding-top: 6rem; transition: right 0.4s ease-in-out; z-index: 1004; }
            .main-nav.open { right: 0; }
            .main-nav ul { flex-direction: column; align-items: center; gap: 1.5rem; }
            .main-nav a { color: var(--color-heading); font-size: 1.2rem; }
        }
    </style>
</head>
<body class="fade-in">

    <script>
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>

    <!-- Header (Same as INDEX.HTML) -->
    <header class="main-header">
        <div class="container">
            <a href="index.html" class="logo" data-no-transition>ORLANDA</a>
            <div class="header-right">
                <nav class="main-nav" id="main-nav">
                    <ul>
                        <li><a href="index.html#hero">الرئيسية</a></li>
                        <li><a href="index.html#all-products">منتجاتنا</a></li>
                        <li><a href="index.html#about">من نحن</a></li>
                    </ul>
                </nav>
                <div class="header-icons">
                    <!-- NEW: User Auth Area -->
                    <div id="user-area" class="user-area">
                        <a href="login.html">تسجيل الدخول</a>
                        <span class="separator">|</span>
                        <a href="login.html">حساب جديد</a>
                    </div>
                    <div id="user-info" class="user-info" style="display: none;">
                        <span id="user-name"></span>
                        <a href="#" id="logout-btn" class="logout-btn">خروج</a>
                    </div>
                    <!-- END: User Auth Area -->
                    <a href="#" id="open-cart-btn" class="cart-icon" aria-label="سلة التسوق" data-no-transition>
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-counter" class="cart-counter">0</span>
                    </a>
                    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="تبديل الوضع الداكن">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                    </button>
                </div>
                <button id="menu-toggle" class="menu-toggle" aria-label="فتح القائمة" aria-expanded="false">
                    <i class="fas fa-bars"></i>
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="nav-overlay" class="nav-overlay"></div>

    <main>
        <!-- قسم تفاصيل المنتج -->
        <section class="product-page-section" data-id="3" data-name="orlanda المصري" data-price="170" data-image="images/orlanda.png">
            <div class="container">
                <a href="index.html#all-products" class="back-to-products-link" data-no-transition><i class="fas fa-arrow-right"></i> العودة إلى كل المنتجات</a>
                <div class="product-details-grid">
                    <div class="product-image-container">
                        <img src="images/orlanda.png" alt="orlanda المصري" loading="lazy">
                    </div>
                    <div class="product-info-container">
                        <h1>orlanda المصري</h1>
                        <div class="product-page-price">170 جنيه</div>
                        <p class="product-description">
                            تركيبة مصرية أصلية معززة بخلاصة الصبار وزيت الأرجان لتغذية الشعر من الجذور حتى الأطراف. يعمل على ترطيب الشعر الجاف وإعادة الحيوية له، مع إضفاء ملمس ناعم كالحرير. مناسب لجميع أنواع الشعر.
                        </p>
                        <div class="product-actions">
                            <div class="quantity-selector">
                                <label for="quantity">الكمية:</label>
                                <input type="number" id="quantity" value="1" min="1">
                            </div>
                            <button class="btn add-to-cart-btn">أضف للسلة</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer (Same as INDEX.HTML) -->
    <footer class="main-footer">
        <div class="container footer-content">
            <h3>ORLANDA</h3>
            <p>العناية التي يستحقها شعرك.</p>
            <div class="social-links">
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
            <div class="copyright">
                <p>&copy; 2025 ORLANDA. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- Cart Modal (Same as INDEX.HTML) -->
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>سلة التسوق</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div id="cart-items-container"></div>
            <div class="cart-empty-message" style="display: none; text-align: center;">
                <h2 style="font-size: 2rem; color: var(--color-heading); margin-bottom: 1rem;">سلتك فارغة حالياً</h2>
                <a href="index.html#all-products" class="btn" id="close-cart-and-shop">العودة للتسوق</a>
            </div>
            <div id="cart-summary" class="cart-summary" style="display: none;">
                <div class="coupon-section">
                    <input type="text" id="coupon-code" placeholder="أدخل كود الخصم">
                    <button id="apply-coupon-btn" class="btn coupon-btn">تطبيق</button>
                </div>
                <div id="coupon-message" class="coupon-message"></div>
                <div class="summary-row discount-row" style="display: none;">
                    <span>الخصم</span>
                    <span id="cart-discount">-0 جنيه</span>
                </div>
                <div class="summary-row">
                    <span>الإجمالي</span>
                    <span id="cart-total">0 جنيه</span>
                </div>
                <button class="btn checkout-btn">إتمام الشراء</button>
            </div>
        </div>
    </div>

    <!-- All JavaScript from INDEX.HTML + New Logic for this page -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: Page Transition Logic ---
            document.body.classList.add('fade-in'); // Apply fade-in effect on load

            // Function to handle elegant navigation
            function navigateTo(url) {
                document.body.classList.remove('fade-in'); // This will trigger the fade-out
                setTimeout(() => {
                    window.location.href = url;
                }, 400); // Match CSS transition duration
            }

            // Intercept internal link clicks for smooth transition
            document.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                // Check for valid, internal, non-hash, non-special links
                if (link && link.href && link.hostname === window.location.hostname && !link.hash && link.target !== '_blank' && !link.hasAttribute('data-no-transition')) {
                    e.preventDefault();
                    navigateTo(link.href);
                }
            });

            // --- General Site Logic (Copied from INDEX.HTML) ---
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const menuToggle = document.getElementById('menu-toggle');
            const mainNav = document.getElementById('main-nav');
            const navOverlay = document.getElementById('nav-overlay');
            const navLinks = mainNav.querySelectorAll('a');
            const cartModal = document.getElementById('cart-modal');
            const openCartBtn = document.getElementById('open-cart-btn');
            const cartCloseBtn = cartModal.querySelector('.modal-close');
            const closeAndShopBtn = document.getElementById('close-cart-and-shop');
            let cart = JSON.parse(localStorage.getItem('orlandaCart')) || [];
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartEmptyMessage = cartModal.querySelector('.cart-empty-message');
            const cartSummary = document.getElementById('cart-summary');
            const cartTotalEl = document.getElementById('cart-total');
            const cartCounter = document.getElementById('cart-counter');

            // --- جديد: رابط السيرفر ---
            const backendUrl = 'https://orlanda-backend.onrender.com';

            // --- جديد: منطق المصادقة الموحد والاحترافي ---
            async function checkAuthStatus() {
                const token = localStorage.getItem('userToken');
                const userArea = document.getElementById('user-area');
                const userInfo = document.getElementById('user-info');
                const userNameEl = document.getElementById('user-name');
                const logoutBtn = document.getElementById('logout-btn');
                
                if (!userArea || !userInfo) return;

                if (!token) {
                    userArea.style.display = 'flex';
                    userInfo.style.display = 'none';
                    return;
                }

                try {
                    const response = await fetch(`${backendUrl}/api/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const user = await response.json();
                        userArea.style.display = 'none';
                        userInfo.style.display = 'flex';
                        userNameEl.textContent = `أهلاً، ${user.name.split(' ')[0]}`;
                    } else {
                        localStorage.removeItem('userToken');
                        userArea.style.display = 'flex';
                        userInfo.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Authentication check failed:', error);
                    userArea.style.display = 'flex';
                    userInfo.style.display = 'none';
                }

                if (logoutBtn) {
                    logoutBtn.onclick = (e) => { // استخدام onclick لمنع تكرار الحدث
                        e.preventDefault();
                        localStorage.removeItem('userToken');
                        // استخدام دالة الانتقال السلس إذا كانت موجودة
                        if (typeof navigateTo === 'function') {
                            navigateTo(window.location.pathname);
                        } else {
                            window.location.reload();
                        }
                    };
                }
            }

            // Coupon Logic elements
            let discountPercent = 0;
            let appliedCoupon = '';
            const VALID_COUPONS = { "SALE10": 0.10, "ORLANDA20": 0.20, "ASER": 0.15 };
            const applyCouponBtn = document.getElementById('apply-coupon-btn');
            const couponCodeInput = document.getElementById('coupon-code');
            const couponMessage = document.getElementById('coupon-message');
            const cartDiscountRow = cartModal.querySelector('.discount-row');
            const cartDiscountEl = document.getElementById('cart-discount');

            // Dark Mode
            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            });

            // --- Cart Logic (Same as INDEX.HTML) ---
            const renderCart = () => {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    cartEmptyMessage.style.display = 'block';
                    cartSummary.style.display = 'none';
                    // Reset coupon when cart is empty
                    discountPercent = 0;
                    appliedCoupon = '';
                    couponCodeInput.value = '';
                    couponMessage.textContent = '';
                    couponMessage.className = 'coupon-message';
                    cartDiscountRow.style.display = 'none';
                } else {
                    cartEmptyMessage.style.display = 'none';
                    cartSummary.style.display = 'block';
                    let subtotal = 0;
                    cart.forEach(item => {
                        subtotal += item.price * item.quantity;
                    });

                    const discountAmount = subtotal * discountPercent;
                    const finalTotal = subtotal - discountAmount;

                    cart.forEach(item => {
                        const cartItemEl = document.createElement('div');
                        cartItemEl.classList.add('cart-item');
                        cartItemEl.dataset.id = item.id;
                        cartItemEl.innerHTML = `
                            <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                            <div class="cart-item-details"><h4>${item.name}</h4><div class="price">${item.price} جنيه</div></div>
                            <div class="cart-item-actions">
                                <div class="quantity-controls">
                                    <button class="quantity-btn" data-action="decrease">-</button>
                                    <span class="quantity">${item.quantity}</span>
                                    <button class="quantity-btn" data-action="increase">+</button>
                                </div>
                                <button class="remove-item-btn">إزالة</button>
                            </div>`;
                        cartItemsContainer.appendChild(cartItemEl);
                    });

                    if (discountAmount > 0) {
                        cartDiscountRow.style.display = 'flex';
                        cartDiscountEl.textContent = `-${discountAmount.toFixed(2)} جنيه`;
                    } else {
                        cartDiscountRow.style.display = 'none';
                    }
                    cartTotalEl.textContent = `${finalTotal.toFixed(2)} جنيه`;
                }
                updateCartCounter();
                saveCart();
            };
            const updateCartCounter = () => {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartCounter.textContent = totalItems;
                cartCounter.classList.toggle('visible', totalItems > 0);
            };
            const handleCartAction = (e) => {
                const target = e.target;
                const cartItemEl = target.closest('.cart-item');
                if (!cartItemEl) return;
                const productId = cartItemEl.dataset.id;
                const item = cart.find(i => i.id === productId);
                if (target.classList.contains('remove-item-btn')) {
                    cart = cart.filter(i => i.id !== productId);
                } else if (target.classList.contains('quantity-btn')) {
                    if (target.dataset.action === 'increase') item.quantity++;
                    else if (target.dataset.action === 'decrease' && item.quantity > 1) item.quantity--;
                }
                renderCart();
            };
            const saveCart = () => localStorage.setItem('orlandaCart', JSON.stringify(cart));
            const openCart = (e) => {
                e.preventDefault();
                // إعادة قراءة السلة من الذاكرة المحلية في كل مرة يتم فتحها
                // لضمان مزامنة البيانات عند التنقل بين الصفحات
                cart = JSON.parse(localStorage.getItem('orlandaCart')) || [];
                renderCart();
                cartModal.style.display = 'flex'; };
            const closeCart = () => cartModal.style.display = 'none';
            openCartBtn.addEventListener('click', openCart);
            cartCloseBtn.addEventListener('click', closeCart);
            if(closeAndShopBtn) closeAndShopBtn.addEventListener('click', closeCart);
            cartModal.addEventListener('click', (e) => { if (e.target === cartModal) closeCart(); });
            cartItemsContainer.addEventListener('click', handleCartAction);

            // Coupon Logic
            applyCouponBtn.addEventListener('click', () => {
                const code = couponCodeInput.value.trim().toUpperCase();
                couponMessage.textContent = '';
                couponMessage.className = 'coupon-message';

                if (appliedCoupon === code && discountPercent > 0) {
                    couponMessage.textContent = 'هذا الكود مطبق بالفعل.';
                    couponMessage.classList.add('error');
                    return;
                }

                if (VALID_COUPONS[code]) {
                    discountPercent = VALID_COUPONS[code];
                    appliedCoupon = code;
                    couponMessage.textContent = `تم تطبيق خصم ${discountPercent * 100}% بنجاح!`;
                    couponMessage.classList.add('success');
                } else {
                    couponMessage.textContent = 'كود الخصم غير صالح.';
                    couponMessage.classList.add('error');
                }
                renderCart(); // Re-render to apply discount
            });

            // --- Event Promotion Logic (to keep coupons in sync with homepage) ---
            const handleEventPromo = () => {
                // --- إعدادات الحدث ---
                const eventDate = new Date(2024, 8, 23); // 23 سبتمبر 2024
                const daysBefore = 7; // عدد الأيام التي يظهر فيها العرض قبل الحدث
                const promoCouponCode = 'SAUDI94'; // كود الخصم للحدث
                const promoDiscount = 0.15; // 15% خصم

                const today = new Date();
                const startDate = new Date(eventDate);
                startDate.setDate(eventDate.getDate() - daysBefore);

                // إزالة الوقت من التواريخ للمقارنة
                today.setHours(0, 0, 0, 0);
                startDate.setHours(0, 0, 0, 0);
                eventDate.setHours(0, 0, 0, 0);

                // التحقق مما إذا كنا في فترة العرض
                if (today >= startDate && today <= eventDate) {
                    // إضافة كود الخصم إلى قائمة الأكواد الصالحة ديناميكياً
                    VALID_COUPONS[promoCouponCode] = promoDiscount;

                    // إظهار القسم الترويجي فقط إذا كان موجوداً في الصفحة الحالية
                    const promoSection = document.getElementById('event-promo');
                    if (promoSection) {
                        promoSection.style.display = 'block';
                    }
                }
            };

            // --- NEW: Logic for this specific product page ---
            const productPageSection = document.querySelector('.product-page-section');
            if (productPageSection) {
                const addToCartBtn = productPageSection.querySelector('.add-to-cart-btn');
                const quantityInput = productPageSection.querySelector('#quantity');

                addToCartBtn.addEventListener('click', () => {
                    const id = productPageSection.dataset.id;
                    const name = productPageSection.dataset.name;
                    const price = parseFloat(productPageSection.dataset.price);
                    const image = productPageSection.dataset.image;
                    const quantity = parseInt(quantityInput.value, 10) || 1;

                    const existingItem = cart.find(item => item.id === id);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        cart.push({ id, name, price, image, quantity });
                    }
                    
                    saveCart();
                    updateCartCounter();

                    // Visual feedback for user
                    addToCartBtn.textContent = '✓ تمت الإضافة';
                    addToCartBtn.style.backgroundColor = '#28a745'; // Green color
                    setTimeout(() => {
                        addToCartBtn.textContent = 'أضف للسلة';
                        addToCartBtn.style.backgroundColor = ''; // Revert to original color
                    }, 2000);
                });
            }

            // Mobile Menu Logic
            const toggleMenu = () => {
                const isOpen = mainNav.classList.contains('open');
                mainNav.classList.toggle('open');
                menuToggle.classList.toggle('open');
                navOverlay.classList.toggle('open');
                document.body.style.overflow = isOpen ? '' : 'hidden';
            };
            menuToggle.addEventListener('click', toggleMenu);
            navOverlay.addEventListener('click', toggleMenu);
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (mainNav.classList.contains('open')) toggleMenu();
                });
            });

            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                localStorage.setItem('userToken', tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Initial Render
            renderCart();
            handleEventPromo(); // Check and activate event coupons
            checkAuthStatus();
        });
    </script>

</body>
</html>